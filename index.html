<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
        <title>D3 Census Map</title>  
        <script src="http://d3js.org/d3.v4.min.js" charset="utf-8"></script> 
        <!-- <script src="https://unpkg.com/topojson@3"></script> -->
        <script src="http://d3js.org/topojson.v1.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <!-- <script src="http://code.jquery.com/jquery-latest.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.min.js"></script> -->
        <!-- <script src="App.js"></script> -->
        <style>
            svg {
                background: white;
            }
            path {
                fill: #cccccc;
                stroke: #333333;
                stroke-width: 0.5;
            }
        </style>
    </head> 
    <body>
      <h1>US Blocks</h1>
      <div id="map"></div>
      <script>
        var width = 1024,
        height = 800;
        
        var svg = d3.select("body")
                .append("svg")
                .attr("width", width)
                .attr("height", height);    

        // testing with smaller json file
        d3.json("tl_2020_us_county.json", function(error, us) {
        // d3.json("tl_2020_25MA_tabblock20.json", function(error, us) {
            if (error) return console.error(error);

            // testing with smaller json file
            var subunits = topojson.feature(us, us.objects.tl_2020_us_county).features;
            // var subunits = topojson.feature(us, us.objects.tl_2020_25_tabblock20).features;
            
            // console.log(subunits[0].properties)
            subunits.sort(function(s1, s2) {
                return parseFloat(s1.properties["INTPTLON"].slice(1)) - parseFloat(s2.properties["INTPTLON"].slice(1))
                // return parseFloat(s1.properties["INTPTLON20"].slice(1)) - parseFloat(s2.properties["INTPTLON20"].slice(1))
            });

            // number of blocks to display
            var tmpunits = [];
            for (let i = 0; i < subunits.length/25; i++) {
                if (subunits[i].properties["STATEFP"] == '25' && (subunits[i].properties["COUNTYFP"] == '025' || subunits[i].properties["COUNTYFP"] == '017')) {
                    tmpunits.push(subunits[i]);
                }
            }
        
            var projection = d3.geoAlbersUsa()
                .translate([width/2 - 1700, height/2 + 400])
                .scale(5000);
                //.translate([width/2-2000, height/2 + 300]) // +700 for CA
                //.scale(5000);
                
            var map_coord = d3.geoPath()
                .projection(projection);

            svg.selectAll("path")
                .data(tmpunits)
                .enter()
                .append("path")
                .attr("d", map_coord); // map_coord same as: d => map_coord(d)

            console.log('rendered boundaries');

            

            // get racial data for suffolk and middlesex counties
            let csvdata = [];
            d3.csv("county.csv", function(data) {
                for (var i = 0; i < data.length; i++) {
                    if (data[i]["STATE"] == "Massachusetts" && (data[i]["COUNTY"] == "Suffolk County" || data[i]["COUNTY"] == "Middlesex County")) {
                        csvdata.push(data[i]);
                    }                     
                }
                console.log("csvdata 1st elt: ", csvdata[0]);
                console.log("csvdata len inside bracket: ", csvdata.length);
            });
            console.log("csvdata len outside bracket: ", csvdata.length);


            let dots = [];
            function genDotCoord (d) {
                let halfway = Math.floor(d.geometry.coordinates["0"].length/2);
                let max = d.geometry.coordinates["0"][halfway];
                let min = d.geometry.coordinates["0"][0];
                let coordx = Math.random() * (max[0] - min[0]) + min[0];
                let coordy = Math.random() * (max[1] - min[1]) + min[1];
                while (!d3.geoContains(d, [coordx, coordy])) {
                    console.log('nay');
                    coordx = Math.random() * (max[0] - min[0]) + min[0];
                    coordy = Math.random() * (max[1] - min[1]) + min[1];
                }
                let color = "rgb(0, 0, 255)";
                console.log('yay');
                return [coordx, coordy, color];
            };

            tmpunits.forEach(function(d) {
                console.log("subunit: ", d);
                for (let i = 0; i < csvdata.length; i++) {
                    console.log(i);
                    for (let j = 0; j < parseInt(csvdata[i]["U7B003"]); j++) {
                        console.log(j);
                        dots.push(genDotCoord(d));
                    }
                }
                dots.push(genDotCoord(d));
            });


            svg.selectAll('circle')
                .data(dots)
                .enter()
                .append('circle')
                .style('fill', d => d[2])
                .attr('r', 2)
                .attr('transform', function(d) {return "translate(" + projection(d) + ")";});

            console.log("Done");
            // give coord to get pixel
            // console.log(projection([-141.190,52.4739]));
            // pixel to coord
            // console.log(projection.invert([241.20395864818516, 649.6497666026178]));
        });   
        
       
        
    
      </script>
    </body>
</html>


    <!-- 
            var addPointsToMap = function(crimeData) {
                var colorScale  = d3.scale.category10();

                var radiusScale = d3.scale.sqrt()
                    .domain(d3.extent(crimeData, function(crime) { return +crime.TOT; }))
                    .range([2, 15]);

                // Add the tooltip container to the vis container
                // it's invisible and its position/contents are defined during mouseover
                var tooltip = d3.select("#map-container").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                // tooltip mouseover event handler
                var tipMouseover = function(d) {
                    this.setAttribute("class", "circle-hover"); // add hover class to emphasize

                    var color = colorScale(d.CR);
                    var html  = "<span style='color:" + color + ";'>" + d.CR + "</span><br/>" +
                                "Count: " + d.TOT + "<br/>Date: " + d.MO + "/" + d.YR;

                    tooltip.html(html)
                        .style("left", (d3.event.pageX + 15) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                      .transition()
                        .duration(200) // ms
                        .style("opacity", .9) // started as 0!
                };

                // tooltip mouseout event handler
                var tipMouseout = function(d) {
                    this.classList.remove("circle-hover"); // remove hover class

                    tooltip.transition()
                        .duration(300) // ms
                        .style("opacity", 0); // don't care about position!
                };

                svg.selectAll("circle")
                    .data(crimeData)
                  .enter().append("circle")
                    .attr("fill", function(d) { return colorScale(d.CR); })
                    .attr("cx", function(d) { return projection([+d.longitude, +d.latitude])[0]; })
                    .attr("cy", function(d) { return projection([+d.longitude, +d.latitude])[1]; })
                    .attr("r",  function(d) { return radiusScale(+d.TOT); })
                    .on("mouseover", tipMouseover)
                    .on("mouseout", tipMouseout);

                addLegend(colorScale);
            };

            var addLegend = function(colorScale) {
                var legendMarginTop  = 50,
                    legendMarginLeft = 30,
                    legendWidth  = 250,
                    legendHeight = 150;

                var legend = svg.append('g')
                    .attr('width', legendWidth)
                    .attr('height', legendHeight)
                    .attr("transform", "translate(" + legendMarginLeft + "," + legendMarginTop + ")");

                var legends = legend.selectAll(".legend")
                    .data(colorScale.domain())
                  .enter().append("g")
                    .attr("class", "legend")
                    .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

                // draw legend colored rectangles
                legends.append("rect")
                    .attr("x", legendWidth - 18)
                    .attr("width", 18)
                    .attr("height", 18)
                    .style("fill", colorScale);

                // draw legend text
                legends.append("text")
                    .attr("x", legendWidth - 24)
                    .attr("y", 9)
                    .attr("dy", ".35em")
                    .style("text-anchor", "end")
                    .text(function(d) { return d.toLowerCase(); });
            };
